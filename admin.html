<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Admin Console - Council Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-secondary mb-4">
        <div class="container">
            <span class="navbar-brand">Council Hub <span class="badge bg-dark">ADMIN</span></span>
            <button id="logoutBtn" class="btn btn-outline-light btn-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </nav>

    <div class="container">
        <!-- 1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="card mb-4 p-3 shadow-sm">
            <h5>â• æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ </h5>
            <form id="addSecretForm" class="row g-2">
                <div class="col-md-3"><input type="text" class="form-control" id="serviceName" placeholder="ã‚µãƒ¼ãƒ“ã‚¹å (ä¾‹: Twitter)" required></div>
                <div class="col-md-3"><input type="text" class="form-control" id="serviceUser" placeholder="ID / Email" required></div>
                <div class="col-md-3"><input type="text" class="form-control" id="servicePass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required></div>
                <div class="col-md-3"><button type="submit" class="btn btn-success w-100">è¿½åŠ </button></div>
            </form>
        </div>

        <!-- 2. æ¨©é™ç®¡ç†ãƒãƒˆãƒªã‚¯ã‚¹ -->
        <div class="card p-3 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>ğŸ” å…±æœ‰æ¨©é™ç®¡ç†</h5>
                <button class="btn btn-sm btn-outline-primary" id="refreshBtn">æ›´æ–°</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-bordered text-center align-middle" id="matrixTable">
                    <thead class="table-light" id="tableHead">
                        <!-- JSã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’åˆ—ã¨ã—ã¦ç”Ÿæˆ -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- JSã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡Œã¨ã—ã¦ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, signOut, onAuthStateChanged, collection, addDoc, getDocs, updateDoc, doc } from './firebase-config.js';

        let users = []; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let secrets = []; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
            // ã“ã“ã§ç°¡æ˜“çš„ã«Adminãƒã‚§ãƒƒã‚¯ï¼ˆå®Ÿéš›ã¯Cloud Functionsç­‰ã§ã‚„ã‚‹ã¹ãï¼‰
            if (user.email !== "admin@school.com") {
                alert("ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
                window.location.href = "dashboard.html";
            }
            initAdmin();
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
        document.getElementById('refreshBtn').addEventListener('click', initAdmin);

        // åˆæœŸåŒ–ï¼šãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æç”»
        async function initAdmin() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
            const usersSnap = await getDocs(collection(db, "users"));
            users = [];
            usersSnap.forEach(d => users.push(d.data()));

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å–å¾—
            const secretsSnap = await getDocs(collection(db, "secrets"));
            secrets = [];
            secretsSnap.forEach(d => secrets.push({ id: d.id, ...d.data() }));

            renderMatrix();
        }

        // ãƒãƒˆãƒªã‚¯ã‚¹è¡¨ã®æç”»
        function renderMatrix() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ (ã‚µãƒ¼ãƒ“ã‚¹å + ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ—)
            let headerHTML = `<tr><th>ã‚µãƒ¼ãƒ“ã‚¹å</th>`;
            users.forEach(u => {
                headerHTML += `<th>${u.email.split('@')[0]}<br><span class="small text-muted">(${u.role})</span></th>`;
            });
            headerHTML += `</tr>`;
            thead.innerHTML = headerHTML;

            // ãƒœãƒ‡ã‚£ç”Ÿæˆ (è¡Œã”ã¨ã«ã‚µãƒ¼ãƒ“ã‚¹)
            let bodyHTML = '';
            secrets.forEach(s => {
                bodyHTML += `<tr><td class="fw-bold text-start">${s.serviceName}</td>`;
                users.forEach(u => {
                    // æ¨©é™ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const isChecked = s.allowedUsers && s.allowedUsers.includes(u.uid) ? 'checked' : '';
                    bodyHTML += `
                        <td>
                            <input type="checkbox" class="form-check-input" 
                                onchange="togglePerm('${s.id}', '${u.uid}', this.checked)" ${isChecked}>
                        </td>`;
                });
                bodyHTML += `</tr>`;
            });
            tbody.innerHTML = bodyHTML;
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¿½åŠ å‡¦ç†
        document.getElementById('addSecretForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('serviceName').value;
            const user = document.getElementById('serviceUser').value;
            const pass = document.getElementById('servicePass').value;

            await addDoc(collection(db, "secrets"), {
                serviceName: name,
                username: user,
                password: pass,
                allowedUsers: [] // æœ€åˆã¯èª°ã‚‚è¦‹ã‚Œãªã„
            });
            
            document.getElementById('addSecretForm').reset();
            initAdmin();
        });

        // æ¨©é™åˆ‡ã‚Šæ›¿ãˆå‡¦ç† (Globalç™»éŒ²)
        window.togglePerm = async (secretId, userId, isChecked) => {
            const secret = secrets.find(s => s.id === secretId);
            let newAllowed = secret.allowedUsers || [];

            if (isChecked) {
                if (!newAllowed.includes(userId)) newAllowed.push(userId);
            } else {
                newAllowed = newAllowed.filter(id => id !== userId);
            }

            // DBæ›´æ–°
            await updateDoc(doc(db, "secrets", secretId), {
                allowedUsers: newAllowed
            });
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°ï¼ˆå†æç”»é˜²æ­¢ã®ãŸã‚ï¼‰
            secret.allowedUsers = newAllowed;
        };
    </script>
</body>
</html>
